<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Programming Game</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
    h1 { margin-bottom: 10px; font-size: 28px; color: #333; }
    .controls { margin-bottom: 20px; }
    #btn-start { background: #3498db; color: #fff; border: none; padding: 12px 24px; font-size: 18px; border-radius: 6px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: background 0.3s; }
    #btn-start:hover { background: #2980b9; }
    .game-wrapper { display: flex; gap: 20px; align-items: flex-start; }
    #board { display: grid; grid-template-columns: repeat(30, 24px); grid-template-rows: repeat(20, 24px); gap: 1px; background: #333; padding: 1px; }
    .cell { width: 24px; height: 24px; background: #fff; display: flex; align-items: center; justify-content: center; font-size: 14px; user-select: none; }
    .star { font-size: 16px; color: gold; }
    .player1 { color: #e74c3c; } .player2 { color: #3498db; } .player3 { color: #2ecc71; }
    .player4 { color: #f39c12; } .player5 { color: #9b59b6; } .player6 { color: #1abc9c; }
    #scoreboard { width: 200px; background: #fff; padding: 16px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    #scoreboard h2 { margin-top: 0; font-size: 20px; text-align: center; color: #333; }
    #scores-list { list-style: none; padding: 0; margin: 0; }
    #scores-list li { background: #f9f9f9; margin: 8px 0; padding: 8px 12px; border-radius: 4px; font-size: 16px; display: flex; justify-content: space-between; }
  </style>
</head>
<body>
  <h1>Programming Game: Collect the Stars</h1>
  <div class="controls">
    <button id="btn-start">Start</button>
  </div>

  <div class="game-wrapper">
    <div id="board"></div>
    <div id="scoreboard">
      <h2>Scores</h2>
      <ul id="scores-list"></ul>
    </div>
  </div>

  <script>
    // Exactly 6 players
    const NB_PLAYERS = 6;
    const rows = 20, cols = 30;

    let players = [], stars = [], scores = [], loop = 0;
    let gameInterval = null;
    let gameId = null; // unique id per game so multiple viewers can run their own session

    const boardEl = document.getElementById('board');

    document.getElementById('btn-start').addEventListener('click', async () => {
      // Create a new game on the server (returns a game_id)
      const resp = await fetch('start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nbplayers: NB_PLAYERS })
      });
      const data = await resp.json();
      gameId  = data.game_id;
      players = data.players;
      stars    = data.stars;
      scores  = data.scores;
      loop    = 0;

      initBoard();
      draw();

      if (gameInterval) clearInterval(gameInterval);
      gameInterval = setInterval(nextMove, 1000);
    });

    function initBoard() {
      boardEl.innerHTML = '';
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const cell = document.createElement('div');
          cell.id = `cell-${r}-${c}`;
          cell.className = 'cell';
          boardEl.appendChild(cell);
        }
      }
    }

    function draw() {
      document.querySelectorAll('.cell').forEach(cell => {
        cell.textContent = '';
        cell.classList.remove('star');
        for (let i = 1; i <= NB_PLAYERS; i++) cell.classList.remove(`player${i}`);
      });

      stars.forEach(([r, c]) => {
        const cell = document.getElementById(`cell-${r}-${c}`);
        cell.textContent = 'â˜…';
        cell.classList.add('star');
      });

      players.forEach(([r, c], idx) => {
        const num = idx + 1;
        const cell = document.getElementById(`cell-${r}-${c}`);
        cell.textContent = num;
        cell.classList.add(`player${num}`);
      });

      updateScores();
    }

    function updateScores() {
      const ul = document.getElementById('scores-list');
      ul.innerHTML = '';
      scores.forEach((sc, idx) => {
        const li = document.createElement('li');
        li.textContent = `Player ${idx+1}`;
        const span = document.createElement('span');
        span.textContent = sc;
        li.appendChild(span);
        ul.appendChild(li);
      });
    }

    async function nextMove() {
      if (!gameId) return;
      try {
        const resp = await fetch('move', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ game_id: gameId, players: players, stars: stars, loop: loop })
        });
        const data = await resp.json();
        if (data.error) throw new Error(data.error);
        players = data.coord;
        scores  = data.scores;
        loop++;

        // Remove collected stars (server already scored)
        stars = stars.filter(([lr, lc]) => !players.some(([pr, pc]) => pr === lr && pc === lc));
        draw();

        if (stars.length === 0) {
          clearInterval(gameInterval);
          showWinner();
        }
      } catch (err) {
        console.error('Move error:', err);
        clearInterval(gameInterval);
      }
    }

    function showWinner() {
      const maxScore = Math.max(...scores);
      const winners = scores
        .map((s, i) => s === maxScore ? i + 1 : null)
        .filter(i => i !== null);
      alert(`Winner(s): Player ${winners.join(', ')} with ${maxScore} star(s)!`);
    }
  </script>
</body>
</html>
